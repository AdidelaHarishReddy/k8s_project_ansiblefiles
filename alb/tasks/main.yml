---
# tasks file for alb
    - name: adding aws eks-charts for installing the aws-load-balancer-controller
      ansible.builtin.shell: | 
        helm repo add eks https://aws.github.io/eks-charts
        helm repo update
      environment:
          KUBECONFIG: /home/ubuntu/.kube/config
      become: false
      register: app_create_result
      failed_when: "'already exists' not in app_create_result.stderr and app_create_result.rc != 0" 

    - name: installing or upgrading the aws-load-balancer-controller
      ansible.builtin.shell: | 
        helm install aws-load-balancer-controller eks/aws-load-balancer-controller \
        -n kube-system \
        --set clusterName=my_cluster \
        --set region=ap-south-1
      environment:
          KUBECONFIG: /home/ubuntu/.kube/config
      register: app_create_result
      failed_when: "'cannot re-use a name that is still in use' not in app_create_result.stderr and app_create_result.rc != 0" 
      become: false

    - name: copying the ingress.yaml resource file to the remote server
      ansible.builtin.copy:
        src: ingress.yaml
        dest: /tmp/ingress.yaml
        owner: ubuntu
        group: ubuntu
        mode: '0777'
    
    - name: apply ingress resource
      ansible.builtin.shell: |
        sleep 300
        kubectl apply -f /tmp/ingress.yaml -n project
      environment:
        KUBECONFIG: /home/ubuntu/.kube/config
      register: ingress_result
      failed_when: ingress_result.rc != 0

    # - name: copying the ingress.yaml resource file to the remote server
    #   ansible.builtin.copy: |
    #      src: ingress.yaml           # file inside the role's "files" folder
    #      dest: /tmp/ingress.yaml     # destination path on the target host
    #      owner: ubuntu                 # optional
    #      group: ubuntu               # optional
    #      mode: '0777'                # optional, file permissions
    #   environment:
    #       HOME: /home/ubuntu

    # - name: running the ingress resource in project namespace for project application
    #   ansible.builtin.shell: |
    #     kubectl apply -f ingress.yaml -n project
    #   environment:
    #       KUBECONFIG: /home/ubuntu/.kube/config
    #   become: false
    #   register: app_create_result
    #   failed_when: "'already exists' not in app_create_result.stderr and app_create_result.rc != 0"

